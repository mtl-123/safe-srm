name: Build & Release Static Binary
on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:
permissions:
  contents: write
  packages: write
  actions: read
  id-token: write
jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends build-essential gh libc6-dev upx-ucl
          gcc --version
          gh --version
          upx --version || echo "UPX版本检查完成"
      - name: Build Static Binary
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"
          RUSTFLAGS="-C target-cpu=native -C link-arg=-static -C link-arg=-static-libgcc -C link-arg=-static-libstdc++ -C opt-level=3 -C panic=abort -C strip=symbols -C debuginfo=0 -C codegen-units=1"
          cargo build --release -v
          ls -lh target/release/
          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: 二进制文件未生成！"
            exit 1
          fi
          file "$BIN_PATH" | grep -qi "statically linked" || {
            echo "WARNING: 未完全静态链接，但仍可运行"
            file "$BIN_PATH"
          }
          strip --strip-all "$BIN_PATH"
      - name: Verify Original Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"
          chmod +x "$BIN_PATH"
          if ! "$BIN_PATH" -h > /dev/null 2>&1; then
            echo "ERROR: 原始二进制运行失败！"
            "$BIN_PATH" -h 2>&1
            exit 1
          fi
      - name: Compress Binary with UPX-UCL
        id: upx_compress
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"
          cp "$BIN_PATH" "${BIN_PATH}.backup"
          ls -lh "$BIN_PATH"
          ORIG_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          upx --best --lzma --force --strip-relocs=0 -q "$BIN_PATH" || {
            echo "WARNING: UPX压缩失败，使用原始二进制"
            cp "${BIN_PATH}.backup" "$BIN_PATH"
            echo "compressed=false" >> $GITHUB_OUTPUT
            exit 0
          }
          ls -lh "$BIN_PATH"
          COMP_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          COMP_RATIO=$(echo "scale=2; $COMP_SIZE/$ORIG_SIZE*100" | bc)
          echo "压缩率: ${COMP_RATIO}% (原始: $ORIG_SIZE 字节, 压缩后: $COMP_SIZE 字节)"
          rm -f "${BIN_PATH}.backup"
          echo "compressed=true" >> $GITHUB_OUTPUT
      - name: Verify Compressed Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"
          BACKUP_PATH="${BIN_PATH}.backup"
          chmod +x "$BIN_PATH"
          if ! "$BIN_PATH" -h > /dev/null 2>&1; then
            echo "WARNING: 压缩后二进制运行失败，回滚到原始二进制"
            if [ -f "$BACKUP_PATH" ]; then
              cp "$BACKUP_PATH" "$BIN_PATH"
            fi
            if ! "$BIN_PATH" -h > /dev/null 2>&1; then
              echo "ERROR: 原始二进制也无法运行！"
              "$BIN_PATH" -h 2>&1
              exit 1
            fi
          fi
          rm -f "$BACKUP_PATH"
      - name: Package (SRM Naming)
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="srm"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            if [ "${{ steps.upx_compress.outputs.compressed }}" == "false" ]; then
              FINAL_BIN="srm-${VERSION}-linux-x86_64-static"
            else
              FINAL_BIN="srm-${VERSION}-linux-x86_64-static-upx"
            fi
          else
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:8}"
            if [ "${{ steps.upx_compress.outputs.compressed }}" == "false" ]; then
              FINAL_BIN="srm-dev-${SHORT_SHA}-linux-x86_64-static"
            else
              FINAL_BIN="srm-dev-${SHORT_SHA}-linux-x86_64-static-upx"
            fi
            VERSION="dev-${SHORT_SHA}"
          fi
          cp target/release/${BIN_NAME} release/${FINAL_BIN}
          chmod +x release/${FINAL_BIN}
          sha256sum release/${FINAL_BIN} | awk '{print $1 "  " $2}' > release/${FINAL_BIN}.sha256
          echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
          echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          ls -lh release/
          cat release/${FINAL_BIN}.sha256
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: srm-linux-x86_64-static-${{ steps.package.outputs.version }}
          path: release/
          retention-days: 30
          if-no-files-found: error
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BIN_FILE="${{ steps.package.outputs.final_bin }}"
          SUM_FILE="${{ steps.package.outputs.final_sum }}"
          TAG_VERSION="${{ steps.package.outputs.version }}"
          REPO="${{ github.repository }}"
          if [ ! -f "$BIN_FILE" ] || [ ! -f "$SUM_FILE" ]; then
            echo "FATAL: Release files missing!"
            ls -lh release/
            exit 1
          fi
          chmod +r "$BIN_FILE" "$SUM_FILE"
          if [ "${{ steps.upx_compress.outputs.compressed }}" == "false" ]; then
            RELEASE_TITLE="Release ${TAG_VERSION} (Static Binary)"
          else
            RELEASE_TITLE="Release ${TAG_VERSION} (Static Binary, UPX Compressed)"
          fi
          gh api -X DELETE repos/$REPO/releases/tags/$TAG_VERSION 2>/dev/null || true
          gh release create "$TAG_VERSION" \
            --title "$RELEASE_TITLE" \
            --generate-notes \
            --repo "$REPO" \
            "$BIN_FILE" \
            "$SUM_FILE"
          gh release view "$TAG_VERSION" --repo "$REPO" --json assets --jq '.assets[] | {name, size}'